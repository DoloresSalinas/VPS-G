name: Deploy VPS Azure Blue-Green

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types: [ "completed" ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Lowercase repository name
        id: vars
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_OUTPUT

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2922
          script: |
            mkdir -p /home/${{ secrets.SSH_USER }}/app
            mkdir -p /home/${{ secrets.SSH_USER }}/app/nginx

      - name: Upload application files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2922
          source: "."
          target: "/home/${{ secrets.SSH_USER }}/app"
          strip_components: 0

      - name: Configure Nginx if needed
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2922
          script: |
            if [ ! -f /etc/nginx/nginx.conf ] || [ ! -f /etc/nginx/conf.d/upstream.conf ]; then
              echo "Configuring Nginx for the first time..."
              chmod +x /home/${{ secrets.SSH_USER }}/app/Scripts/setup-nginx.sh
              /home/${{ secrets.SSH_USER }}/app/Scripts/setup-nginx.sh
            else
              echo "Nginx is already configured"
            fi

      - name: Set execute permissions and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2922
          envs:
            DATABASE_URL: ${{ secrets.DATABASE_URL }}
            K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
            REGISTRY_USER: ${{ github.actor }}
            REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          script: |
            set -e
            cd /home/${{ secrets.SSH_USER }}/app
            
            # Set execution permissions
            chmod +x Scripts/*.sh
            chmod +x nginx/*.sh
            
            # Set environment variables
            export DATABASE_URL="$DATABASE_URL"
            export K6_CLOUD_TOKEN="$K6_CLOUD_TOKEN"
            export REGISTRY_USER="$REGISTRY_USER"
            export REGISTRY_TOKEN="$REGISTRY_TOKEN"
            
            # Construct image name
            IMAGE="ghcr.io/${{ steps.vars.outputs.REPO_LOWER }}:${{ github.sha }}"
            echo "Deploying image: $IMAGE"
            
            # Execute blue-green deployment
            bash -x Scripts/deploy_blue_green.sh "$IMAGE"