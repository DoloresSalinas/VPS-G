name: Deploy Only

on:
  workflow_dispatch:  # Permite ejecuciÃ³n manual
  push:
    branches: [main]
    paths:
      - 'Scripts/**'
      - 'nginx/**'
      - 'docker-compose.yml'
      - 'Dockerfile'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Lowercase repository name
        id: vars
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "REPO_LOWER=$REPO_LOWER" >> $GITHUB_OUTPUT
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2922
          script: |
            set -e
            cd /home/${{ secrets.SSH_USER }}/app
            
            # Pull latest code
            git pull origin main
            
            # Ensure scripts are executable
            chmod +x Scripts/*.sh
            chmod +x nginx/*.sh
            
            # Use latest image from GHCR or local build
            LATEST_IMAGE="ghcr.io/${{ steps.vars.outputs.REPO_LOWER }}:latest"
            
            # Deploy
            export DATABASE_URL="${{ secrets.DATABASE_URL }}"
            export K6_CLOUD_TOKEN="${{ secrets.K6_CLOUD_TOKEN }}"
            bash Scripts/deploy_blue_green.sh "$LATEST_IMAGE"